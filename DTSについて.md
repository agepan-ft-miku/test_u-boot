GStreamer における DTS は、「**Decode TimeStamp (デコードタイムスタンプ)**」の略です。これは、各メディアバッファ (`GstBuffer`) がデコーダによっていつデコード（復号）されるべきかを示すタイムスタンプです。

PTS (Presentation TimeStamp) が「いつ表示されるべきか」を示すのに対し、DTS は「いつデコード処理が行われるべきか」という、デコーダの視点でのタイミング情報を提供します。

### DTS の基本

  * **目的**: デコーダがメディアデータを処理する正しい順序とタイミングを決定するために使用されます。
  * **単位**: PTS と同様に、通常はナノ秒単位のストリーム時間で表されます。
  * **`GstBuffer` 内の格納**: `GstBuffer` 構造体には `dts` というメンバがあり、ここに格納されます。マクロ `GST_BUFFER_DTS(buf)` を使ってアクセスできます。
    ```c
    // gst/gstbuffer.h より GstBuffer 構造体の一部
    struct _GstBuffer {
      // ... 他のメンバ ...
      GstClockTime pts; // Presentation TimeStamp
      GstClockTime dts; // Decode TimeStamp
      GstClockTime duration; // Duration
      // ... 他のメンバ ...
    };
    ```
  * **存在**: すべてのメディアストリームやバッファに DTS が存在するわけではありません。DTS が存在しない場合、`GST_BUFFER_DTS(buf)` は `GST_CLOCK_TIME_NONE` という特別な値を返します。

### DTS と PTS の関係

DTS と PTS の関係は、メディアストリームのエンコード方式、特にフレーム間の依存関係によって決まります。

1.  **デコード順と表示順が同じ場合**:

      * 多くのシンプルなメディアフォーマットや、プログレッシブビデオ（フレーム間の再تيبえ (reordering) が不要なもの）では、バッファがデコードされるべき順序と、表示されるべき順序は同じです。
      * このような場合、DTS は PTS と同じ値になるか、あるいは DTS 自体が設定されない（`GST_CLOCK_TIME_NONE`）ことがあります。DTS がない場合、デコーダは通常、PTS をデコードタイミングの基準とします。

2.  **デコード順と表示順が異なる場合 (Bフレームなど)**:

      * これが DTS が特に重要になるケースです。一部の高度なビデオコーデック（例: H.264/AVC, H.265/HEVC, MPEG-2 Video）では、圧縮効率を高めるために **Bフレーム (Bi-directionally predicted frames)** が使用されます。
      * Bフレームは、その内容をデコードするために、時間的に「前」のフレームと「後」のフレームの両方を参照する必要があります。
      * このため、表示順では後になる参照フレーム（例: Pフレームや他のIフレーム）を、Bフレームよりも先にデコードしなければなりません。
      * **例**:
          * **表示順 (PTS順)**: `I0 P3 B1 B2 P6 B4 B5 ...` (添字は表示時刻の昇順)
          * **デコード順 (DTS順)**: `I0 P3 P6 B1 B2 B4 B5 ...` (B1, B2をデコードするにはP3とP6が必要なので、P6が先にデコードされる)
      * このような場合、一部のフレームでは DTS が PTS よりも早い時刻を示します。つまり、表示されるのは後でも、デコード処理は先に行う必要があるということです。

### GStreamer エレメントによる DTS の扱い

  * **デマクサ (Demuxer)**:
      * `matroskademux`, `qtdemux` (MP4), `tsdemux` (MPEG-TS) などのデマクサエレメントは、コンテナフォーマットからDTS情報を（もし存在すれば）抽出し、出力する `GstBuffer` に設定します。
  * **デコーダ (Decoder)**:
      * `avdec_h264`, `decodebin` などのデコーダエレメントは、入力バッファの DTS を見て、バッファを処理する順序を決定します。
      * Bフレームなどによりデコード順と表示順が異なる場合、デコーダは内部的にフレームを並べ替える (reordering) 必要があり、デコードされたフレームが正しいPTS順で出力されるようにします。
      * DTS が存在しないバッファを受け取った場合、デコーダは通常PTSをデコードのタイミング/順序の基準とします。
  * **エンコーダ (Encoder) / ミュークサ (Muxer)**:
      * エンコーダ（例: `x264enc`）がBフレームを生成する場合、適切なPTSとDTSを計算してバッファに設定します。
      * ミュークサ（例: `mp4mux`, `matroskamux`）は、これらのタイムスタンプ情報を含むバッファをコンテナフォーマットに従って多重化します。
  * **その他のエレメント (フィルター、シンクなど)**:
      * 通常、デコーダより下流のエレメント（フィルターやシンク）は、主にPTSに基づいて動作します。なぜなら、デコード後のデータは表示順（PTS順）に並んでいることが期待されるためです。

### DTS がない場合

前述の通り、`GST_BUFFER_DTS(buf)` が `GST_CLOCK_TIME_NONE` を返す場合、そのバッファには有効なDTSが設定されていません。多くのケースでは、これはデコード順と表示順が同じであるか、あるいはDTS情報が元々ストリームに含まれていないことを意味します。この場合、デコーダはPTSをデコードのタイミングと順序の基準としてフォールバックするのが一般的です。

### なぜ DTS が重要か？

  * **圧縮効率の向上**: Bフレームのようなフレーム間予測技術は、ビデオの圧縮効率を大幅に向上させることができます。DTSは、これらの技術を正しく機能させるために不可欠です。
  * **スムーズな再生**: 正しい順序でフレームがデコーダに供給されることで、依存関係のあるフレームが時間通りにデコードされ、結果としてアーティファクトのないスムーズな再生が可能になります。

GStreamerにおいて、DTSは特に複雑なビデオコーデックを扱う際に、PTSと連携して正確なデコードとレンダリングを実現するための重要な要素です。
